{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "/webhook/7ab5d664-349d-4ad2-84f1-23da3b2df1a7/webhook",
        "authentication": "headerAuth",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        9856,
        784
      ],
      "id": "4dd03e91-9894-41f4-b0f4-c4dae191e31b",
      "name": "Webhook",
      "webhookId": "202e25de-310d-4001-bdbd-2520da68de5c",
      "credentials": {
        "httpHeaderAuth": {
          "id": "3rBaJq0jL2hLih4A",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "descriptionType": "manual",
        "toolDescription": "Nessa ferramenta temos os Procedimento e √Åreas de Aplica√ß√£o com seus Valores e Valores de Oferta em R$ (Real)",
        "documentId": {
          "__rl": true,
          "value": {},
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 1667361004,
          "mode": "list",
          "cachedResultName": "Pre√ßos Gerais",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1lZrtlFpEcbzVT5UfNXcs9wpP-v1YwNE5JnaLfvxA-VA/edit#gid=1667361004"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheetsTool",
      "typeVersion": 4.7,
      "position": [
        12432,
        976
      ],
      "id": "9d0d20be-d7ec-4a59-a8ac-3230da4acd01",
      "name": "Tabela de Pre√ßos"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "PAIZPk6Yh1l2zQON",
          "mode": "list",
          "cachedResultName": "Atendimento Nova Forge",
          "cachedResultUrl": "/projects/GvKfk2Y7L7rLi2zA/datatables/PAIZPk6Yh1l2zQON"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "keyValue": "={{ $json.session_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "sessionId": "={{ $json.session_id }}",
            "ultima_pergunta_contato": "={{ $json.input }}"
          },
          "matchingColumns": [
            "sessionId"
          ],
          "schema": [
            {
              "id": "sessionId",
              "displayName": "sessionId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "nome_completo",
              "displayName": "nome_completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "interesse",
              "displayName": "interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "historico_tratamento",
              "displayName": "historico_tratamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "data_agendamento",
              "displayName": "data_agendamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "agendamento_id",
              "displayName": "agendamento_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ultima_pergunta_contato",
              "displayName": "ultima_pergunta_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "ultima_resposta_ia",
              "displayName": "ultima_resposta_ia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        10256,
        784
      ],
      "id": "7f4890a2-f961-491b-8888-a463f9a265a9",
      "name": "Criar/atualizar sessionId"
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "PAIZPk6Yh1l2zQON",
          "mode": "list",
          "cachedResultName": "Atendimento Nova Forge",
          "cachedResultUrl": "/projects/GvKfk2Y7L7rLi2zA/datatables/PAIZPk6Yh1l2zQON"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "keyValue": "={{ $('Define:Mensagem e Session_id').first().json.session_id }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        10432,
        784
      ],
      "id": "a12877e0-6f94-4d0f-b1cf-eae93136ec11",
      "name": "Get row(s)",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "PAIZPk6Yh1l2zQON",
          "mode": "list",
          "cachedResultName": "Atendimento Nova Forge",
          "cachedResultUrl": "/projects/GvKfk2Y7L7rLi2zA/datatables/PAIZPk6Yh1l2zQON"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "keyValue": "={{ $('Define:Mensagem e Session_id').first().json.session_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "nome_completo": "={{ ($('Information Extractor').first().json.output.nome_completo || $('Get row(s)').first().json.nome_completo || '') }}",
            "interesse": "={{ ($('Information Extractor').first().json.output.interesse || $('Get row(s)').first().json.interesse || '') }}",
            "historico_tratamento": "={{ ($('Information Extractor').first().json.output.historico_tratamento || $('Get row(s)').first().json.historico_tratamento || '') }}",
            "data_agendamento": "={{ $('Information Extractor').first().json.output.data_agendamento || $('Get row(s)').first().json.data_agendamento || null }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "sessionId",
              "displayName": "sessionId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "nome_completo",
              "displayName": "nome_completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "interesse",
              "displayName": "interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "historico_tratamento",
              "displayName": "historico_tratamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "data_agendamento",
              "displayName": "data_agendamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "agendamento_id",
              "displayName": "agendamento_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ultima_pergunta_contato",
              "displayName": "ultima_pergunta_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ultima_resposta_ia",
              "displayName": "ultima_resposta_ia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        11520,
        784
      ],
      "id": "8d4e600e-99dd-40ec-8a79-f486e053c0d9",
      "name": "AtualizaVariaveisExtrator"
    },
    {
      "parameters": {
        "operation": "upsert",
        "dataTableId": {
          "__rl": true,
          "value": "PAIZPk6Yh1l2zQON",
          "mode": "list",
          "cachedResultName": "Atendimento Nova Forge",
          "cachedResultUrl": "/projects/GvKfk2Y7L7rLi2zA/datatables/PAIZPk6Yh1l2zQON"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "keyValue": "={{ $('Define:Mensagem e Session_id').first().json.session_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ultima_resposta_ia": "={{ $('AI Agent - Respostas').first().json.output }}",
            "ultima_pergunta_contato": "={{ $('Define:Mensagem e Session_id').first().json.input }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "sessionId",
              "displayName": "sessionId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "nome_completo",
              "displayName": "nome_completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "interesse",
              "displayName": "interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "historico_tratamento",
              "displayName": "historico_tratamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "data_agendamento",
              "displayName": "data_agendamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "agendamento_id",
              "displayName": "agendamento_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ultima_pergunta_contato",
              "displayName": "ultima_pergunta_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "ultima_resposta_ia",
              "displayName": "ultima_resposta_ia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        12208,
        784
      ],
      "id": "4264ed73-2f85-41a3-9f5f-c3531039104c",
      "name": "AtualizaPerguntaResposta"
    },
    {
      "parameters": {
        "operation": "update",
        "dataTableId": {
          "__rl": true,
          "value": "PAIZPk6Yh1l2zQON",
          "mode": "list",
          "cachedResultName": "Atendimento Nova Forge",
          "cachedResultUrl": "/projects/GvKfk2Y7L7rLi2zA/datatables/PAIZPk6Yh1l2zQON"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "keyValue": "={{ $('Define:Mensagem e Session_id').first().json.session_id }}"
            }
          ]
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "agendamento_id": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('agendamento_id', `Atualiza o campo \"agendamento_id\" com o ID obtido da cria√ß√£o do evento. Este ID vem do resultado da ferramenta \"Cria Evento\" no campo \"id\" ou \"data.id\" ou na resposta JSON. Use este ID para referenciar o evento criado.`, 'string') }}",
            "data_agendamento": "={{ $fromAI('data_agendamento', `Atualiza o campo \"data_agendamento\" com a data de in√≠cio do evento criado. Use o campo \"start_at\" do resultado da ferramenta \"Cria Evento\" (pode estar em \"data.start_at\" ou diretamente em \"start_at\") no formato ISO 8601 (ex: 2026-01-15T10:00:00Z). Esta √© a data de in√≠cio do evento que foi criado com sucesso.`, 'string') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "sessionId",
              "displayName": "sessionId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "nome_completo",
              "displayName": "nome_completo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "interesse",
              "displayName": "interesse",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "historico_tratamento",
              "displayName": "historico_tratamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "data_agendamento",
              "displayName": "data_agendamento",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "agendamento_id",
              "displayName": "agendamento_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": false
            },
            {
              "id": "ultima_pergunta_contato",
              "displayName": "ultima_pergunta_contato",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            },
            {
              "id": "ultima_resposta_ia",
              "displayName": "ultima_resposta_ia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "readOnly": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.dataTableTool",
      "typeVersion": 1,
      "position": [
        11856,
        992
      ],
      "id": "50a547ed-45d5-489b-8a91-a096352274b5",
      "name": "Data table Update",
      "notesInFlow": false,
      "notes": "ESSENCIAL: Use esta ferramenta IMEDIATAMENTE ap√≥s usar 'Cria Evento' para salvar o ID do agendamento. Sem isso, o sistema perder√° o agendamento. Par√¢metros: agendamento_id (o ID retornado pela cria√ß√£o) e data_agendamento."
    },
    {
      "parameters": {
        "operation": "get",
        "dataTableId": {
          "__rl": true,
          "value": "PAIZPk6Yh1l2zQON",
          "mode": "list",
          "cachedResultName": "Atendimento Nova Forge",
          "cachedResultUrl": "/projects/GvKfk2Y7L7rLi2zA/datatables/PAIZPk6Yh1l2zQON"
        },
        "filters": {
          "conditions": [
            {
              "keyName": "sessionId",
              "keyValue": "={{ $('Define:Mensagem e Session_id').first().json.session_id }}"
            }
          ]
        },
        "limit": 1
      },
      "type": "n8n-nodes-base.dataTable",
      "typeVersion": 1,
      "position": [
        12032,
        784
      ],
      "id": "2575e12d-f8f0-47f2-825f-8130275435fa",
      "name": "Get row(s)1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Obter o prompt_text do n√≥ '#Prompt Extra√ß√£o de Dados'\nconst promptText = $json.prompt_text || '';\n\n// Fun√ß√£o para escapar chaves simples, mas preservar chaves duplas (n8n expressions)\nfunction escapeCurlyBraces(text) {\n  if (!text) return '';\n  // Substitui { por [ e } por ] para evitar conflito com f-strings do LangChain\n  // Mas n√£o afeta {{...}} que s√£o express√µes do n8n\n  return text.replace(/\\{\\{/g, 'TEMP_DOUBLE_OPEN').replace(/\\}\\}/g, 'TEMP_DOUBLE_CLOSE').replace(/\\{/g, '[').replace(/\\}/g, ']').replace(/TEMP_DOUBLE_OPEN/g, '{{').replace(/TEMP_DOUBLE_CLOSE/g, '}}');\n}\n\nconst escapedPromptText = escapeCurlyBraces(promptText);\n\nreturn [\n  {\n    json: {\n      prompt_text_escaped: escapedPromptText,\n      prompt_text: promptText\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11200,
        784
      ],
      "id": "1b081780-dadc-4831-be42-26d68e42b1f2",
      "name": "Processar Prompt Extractor"
    },
    {
      "parameters": {
        "text": "=Mensagem atual do usu√°rio: {{ $('Define:Mensagem e Session_id').first().json.input }}",
        "attributes": {
          "attributes": [
            {
              "name": "nome_completo",
              "description": "Nome completo do paciente com 2 ou mais palavras."
            },
            {
              "name": "historico_tratamento",
              "description": "Situa√ß√£o atual do projeto: \"Ideia do zero\", \"Sistema legado\", \"Refatora√ß√£o\", \"Primeira vez contratando\"..."
            },
            {
              "name": "interesse",
              "description": "O tipo de solu√ß√£o tecnol√≥gica buscada (ex: App, Sistema Web, Automa√ß√£o, IA, Chatbot)."
            },
            {
              "name": "data_agendamento",
              "description": "Extraia datas futuras mencionadas para reuni√£o."
            }
          ]
        },
        "options": {
          "systemPromptTemplate": "={{ $('Processar Prompt Extractor').first().json.prompt_text_escaped || $('Concatenador #IA de Atendimento e Triagem').first().json.prompt_text_escaped || '' }}\n\n## Dados Atuais do Contato\n\nNome do contato: {{ $('Webhook').first().json.body.message.from.first_name || 'N√£o informado' }}\n\n### Status atual de cada informa√ß√£o:\n\n- Nome Completo: {{ $('Get row(s)').first().json.nome_completo || 'N√£o informado' }}\n- Hist√≥rico de Tratamento: {{ $('Get row(s)').first().json.historico_tratamento || 'N√£o informado' }}\n- Interesse: {{ $('Get row(s)').first().json.interesse || 'N√£o informado' }}\n- Data de Agendamento: {{ $('Get row(s)').first().json.data_agendamento || 'N√£o agendado' }}\n\n## Contexto da Conversa:\n\n### REFER√äNCIA TEMPORAL (IMPORTANTE):\nHoje √©: {{ $now.setZone('America/Sao_Paulo').setLocale('pt-BR').toFormat(\"cccc, dd 'de' MMMM 'de' yyyy\") }}\nUse esta data como base para calcular qualquer termo relativo (ex: \"amanh√£\", \"segunda-feira\").\n\n- √öltima pergunta feita: {{ $('Get row(s)').first().json.ultima_pergunta_contato || 'Nenhuma' }}\n- √öltima resposta dada ao paciente: {{ $('Get row(s)').first().json.ultima_resposta_ia || 'Nenhuma' }}\n\n- Data/Hora Atual da conversa: {{ $now.setLocale('pt-BR').toFormat('cccc') }}, {{ $now.setZone('America/Sao_Paulo').setLocale('pt-BR').toFormat(\"dd 'de' LLLL 'de' yyyy HH:mm'hrs'\") }}\n\n### REGRA ABSOLUTA: N√ÉO INVENTE VALORES\n\n‚ö†Ô∏è CR√çTICO: Voc√™ DEVE retornar APENAS informa√ß√µes que foram mencionadas EXPLICITAMENTE na mensagem do usu√°rio ou que podem ser inferidas com 100% de CERTEZA do contexto.\n\n‚ùå NUNCA FA√áA:\n- Inventar nome completo se o usu√°rio mencionou apenas primeiro nome (ex: se mencionar \"Jo√£o\", N√ÉO retorne \"Jo√£o Silva\")\n- Inferir interesse se n√£o foi mencionado diretamente na mensagem\n- Criar data de agendamento se o usu√°rio n√£o mencionou data/hora futura explicitamente\n- Assumir hist√≥rico de tratamento sem contexto claro e expl√≠cito\n- Preencher campos baseado em suposi√ß√µes ou infer√™ncias n√£o garantidas\n\n‚úÖ SEMPRE FA√áA:\n- Se a informa√ß√£o n√£o foi mencionada, retorne string vazia (\"\") para campos string (nome_completo, historico_tratamento, interesse)\n- Se n√£o houver data mencionada explicitamente, omita o campo data_agendamento ou retorne null\n- Extraia APENAS o que est√° claramente presente na mensagem atual\n- Se houver d√∫vida se uma informa√ß√£o foi mencionada, N√ÉO extraia - √© melhor retornar vazio\n\n### INSTRU√á√ÉO CR√çTICA DE OUTPUT:\nRetorne APENAS o objeto JSON v√°lido, sem markdown, sem code blocks (```), sem explica√ß√µes adicionais.\nApenas o objeto JSON puro, diretamente, sem formata√ß√£o markdown.\n\n### REGRAS OBRIGAT√ìRIAS PARA OS CAMPOS:\n\n1. **nome_completo** (string): \n   - Extraia APENAS se o usu√°rio mencionar nome completo (2+ palavras)\n   - Se mencionar apenas primeiro nome, retorne string vazia \"\" (NUNCA invente sobrenome)\n   - Se n√£o encontrar, retorne string vazia \"\" (NUNCA null)\n\n2. **historico_tratamento** (string): \n   - Extraia APENAS se houver men√ß√£o clara √† situa√ß√£o do projeto\n   - Valores v√°lidos: \"Ideia do zero\", \"Sistema legado\", \"Refatora√ß√£o\", \"Primeira vez contratando\"\n   - Se n√£o houver contexto suficiente, retorne string vazia \"\" (NUNCA null)\n\n3. **interesse** (string): \n   - Extraia APENAS se o cliente mencionar explicitamente o tipo de solu√ß√£o (App, Sistema Web, etc.)\n   - Se n√£o mencionar, retorne string vazia \"\" (NUNCA null)\n\n4. **data_agendamento** (string): \n   - Extraia APENAS se o usu√°rio mencionar EXPLICITAMENTE uma data/hora futura\n   - Se n√£o houver men√ß√£o clara a data/hora, omita o campo ou retorne null\n   - Sempre retorne no formato ISO 8601 UTC (ex: 2026-01-15T10:00:00Z)\n   - NUNCA invente datas ou hor√°rios n√£o mencionados\n\nIMPORTANTE: Campos do tipo string (nome_completo, historico_tratamento, interesse) SEMPRE devem ser strings, nunca null. Use \"\" (string vazia) se a informa√ß√£o n√£o for encontrada ou n√£o foi mencionada explicitamente.\n\nPara o campo data_agendamento, sempre retorne no formato ISO 8601 (ex: 2026-01-15T10:00:00Z) se houver uma data mencionada explicitamente.\nSe n√£o houver data mencionada, n√£o inclua o campo ou retorne null."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1.2,
      "position": [
        11200,
        784
      ],
      "id": "8f964953-aa8a-4099-8990-d07395cfdbe0",
      "name": "Information Extractor",
      "executeOnce": false,
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://controliaa.vercel.app/api/webhooks/n8n/channel-response",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        12624,
        784
      ],
      "id": "4b4e7b46-b554-4031-86f4-1ec0f90f9ae7",
      "name": "HTTP Request (Enviar Resposta)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "85de3930-14ce-48a5-9e78-b68ac68f9f75",
              "name": "input",
              "value": "={{ $json.body.message.text }}",
              "type": "string"
            },
            {
              "id": "cbb5e494-7253-4f18-967f-0f97ef6d3079",
              "name": "session_id",
              "value": "={{ $json.body.controlia.conversation_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        10048,
        784
      ],
      "id": "34a9de49-5560-43bf-a59a-dee8c732cff2",
      "name": "Define:Mensagem e Session_id"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "ai_prompts",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "fe5c1cb7-bc87-4922-9736-8ca6b83ae613"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        10624,
        784
      ],
      "id": "5830efa3-d75a-480b-a6fa-e8d17910444c",
      "name": "#Prompt IA de Atendimento e Triagem",
      "credentials": {
        "supabaseApi": {
          "id": "MJeuWnGfcHw2J9Ll",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Defina aqui a ordem desejada dos IDs\nconst ordemDesejada = ['fe5c1cb7-bc87-4922-9736-8ca6b83ae613'];\n\nconst concatenado = ordemDesejada\n  .map(id => {\n    const item = items.find(i => i.json.id === id);\n    // CORRE√á√ÉO AQUI: Mudamos de .content_prompt para .prompt_text\n    return item ? item.json.prompt_text : null;\n  })\n  .filter(Boolean) // remove nulos\n  .join('\\n');\n\n// Escapar chaves simples do prompt para evitar interpreta√ß√£o como vari√°veis de template pelo LangChain\n// Substitui { por [ e } por ] para evitar conflito com templates do n8n ({{ }}) e LangChain\nconst promptEscapado = concatenado\n  .replace(/\\{\\{/g, 'TEMP_DOUBLE_OPEN')  // Salva chaves duplas temporariamente\n  .replace(/\\}\\}/g, 'TEMP_DOUBLE_CLOSE')\n  .replace(/\\{/g, '[')  // Substitui chaves simples por colchetes\n  .replace(/\\}/g, ']')\n  .replace(/TEMP_DOUBLE_OPEN/g, '{{')  // Restaura chaves duplas\n  .replace(/TEMP_DOUBLE_CLOSE/g, '}}');\n\nreturn [\n  {\n    json: {\n      content_prompt_concatenado: concatenado,\n      prompt_text_escaped: promptEscapado\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        10816,
        784
      ],
      "id": "1754d437-f448-4c0a-9e41-7b604cde2983",
      "name": "Concatenador #IA de Atendimento e Triagem"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "ai_prompts",
        "limit": 1,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "c0827f59-1ff5-4de8-924e-4c16504a5d10"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        11008,
        784
      ],
      "id": "70438d01-544a-49ec-ac82-feaaa9473a45",
      "name": "#Prompt Extra√ß√£o de Dados",
      "credentials": {
        "supabaseApi": {
          "id": "MJeuWnGfcHw2J9Ll",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Obter dados do webhook original\nconst webhookData = $('Webhook').first().json.body || $('Webhook').first().json;\nconst controlia = webhookData.controlia || {};\nconst message = webhookData.message || {};\n\n// Obter resposta da IA\nconst output = $('AI Agent - Respostas').first().json.output;\n\n// Obter dados da linha do DataTable\nconst rowData = $('Get row(s)1').first().json || {};\n\n// Preparar campos customizados para atualizar (s√≥ incluir se n√£o forem null/undefined)\nconst customFields = {};\nif (rowData.interesse) customFields.interesse = rowData.interesse;\nif (rowData.historico_tratamento) customFields.historico_tratamento = rowData.historico_tratamento;\nif (rowData.data_agendamento) customFields.data_agendamento = rowData.data_agendamento;\n\n// Retornar payload completo\nreturn {\n  // Resposta da IA que ser√° enviada ao canal (Telegram, WhatsApp, etc.)\n  output: output,\n  \n  // Dados do Controlia (obrigat√≥rios - j√° v√™m do webhook original)\n  controlia: {\n    company_id: controlia.company_id,\n    contact_id: controlia.contact_id,\n    conversation_id: controlia.conversation_id,\n    message_id: controlia.message_id,\n    channel: controlia.channel || 'telegram',\n    channel_id: controlia.channel_id || message.chat?.id?.toString()\n  },\n  \n  // Dados da mensagem original (opcional, mas recomendado)\n  message: {\n    from: message.from || controlia.message?.from,\n    chat: message.chat || controlia.message?.chat\n  },\n  \n  // ‚úÖ Campos customizados para atualizar no contato (s√≥ se houver valores)\n  ...(Object.keys(customFields).length > 0 ? { custom_fields: customFields } : {})\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12416,
        784
      ],
      "id": "21661a51-b0a4-45d6-85e2-63fd4fc1bcc9",
      "name": "Prepare Response Data"
    },
    {
      "parameters": {
        "toolDescription": "üîç VERIFICA HOR√ÅRIOS DISPON√çVEIS na agenda da empresa no Controlia.\n\n‚ö†Ô∏è USE ESTA FERRAMENTA SEMPRE (OBRIGAT√ìRIO):\n- Quando o cliente perguntar sobre hor√°rios dispon√≠veis (OBRIGAT√ìRIO)\n- ANTES de criar qualquer evento (OBRIGAT√ìRIO)\n- ANTES de atualizar qualquer evento (OBRIGAT√ìRIO)\n- Quando o cliente mencionar interesse em agendar (OBRIGAT√ìRIO)\n\nüìä COMO INTERPRETAR OS RESULTADOS:\n- Se retornar array vazio []: N√£o h√° eventos agendados nos pr√≥ximos 15 dias = AMPLA DISPONIBILIDADE\n- Se retornar eventos: Analise os hor√°rios (start_at e end_at) para identificar:\n  * Hor√°rios ocupados (evitar sugerir)\n  * Janelas de tempo livres (pode sugerir)\n\nüéØ O QUE FAZER COM OS RESULTADOS:\n1. Se vazio: Informe ao cliente que h√° ampla disponibilidade e sugira hor√°rios padr√£o (9h, 10h, 14h, 15h, 16h)\n2. Se houver eventos: Liste os hor√°rios ocupados e sugira alternativas livres\n3. NUNCA invente hor√°rios - use apenas os dados retornados pela ferramenta\n\nA ferramenta busca automaticamente os pr√≥ximos 15 dias a partir de agora.\n\n‚ö†Ô∏è REGRA ABSOLUTA: NUNCA responda sobre disponibilidade SEM usar esta ferramenta primeiro.",
        "url": "https://controliaa.vercel.app/api/calendar/events",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "start",
              "value": "={{ $now.setZone('America/Sao_Paulo').toUTC().toISO() }}"
            },
            {
              "name": "end",
              "value": "={{ $now.setZone('America/Sao_Paulo').plus({ hours: 360 }).toUTC().toISO() }}"
            },
            {
              "name": "status",
              "value": "scheduled"
            },
            {
              "name": "company_id",
              "value": "={{ $('Webhook').first().json.body.controlia.company_id }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoY3N5cHVkcHd3Zmxjb3J5Zm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MjIzMTMsImV4cCI6MjA4MTk5ODMxM30.rguJ34eShUCSKKBWuy8bBS7bSxuC5mCeRnXych0LGKM"
            },
            {
              "name": "x-company-id",
              "value": "={{ $('Webhook').first().json.body.controlia.company_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        11232,
        992
      ],
      "id": "1098e88a-b94f-4c68-b0d8-326ad858997b",
      "name": "Busca Disponibilidades",
      "rewireOutputLogTo": "ai_tool"
    },
    {
      "parameters": {
        "toolDescription": "üîÑ ATUALIZA um evento existente no calend√°rio da empresa no Controlia.\n\n‚ö†Ô∏è REGRAS OBRIGAT√ìRIAS ANTES DE USAR:\n\n1. **OBRIGAT√ìRIO**: Voc√™ DEVE ter usado \"Busca Disponibilidades\" ANTES desta ferramenta\n2. **OBRIGAT√ìRIO**: Verifique que o novo hor√°rio desejado N√ÉO est√° na lista de eventos retornados\n3. **OBRIGAT√ìRIO**: Confirme com o cliente a nova data/hora antes de atualizar\n4. **OBRIGAT√ìRIO**: Voc√™ precisa do ID do evento (agendamento_id) que est√° armazenado na DataTable\n5. **OBRIGAT√ìRIO**: Voc√™ precisa ter uma nova data de agendamento (campo data_agendamento da DataTable ou mencionada pelo cliente)\n\nüìã QUANDO USAR:\n- Cliente solicitou altera√ß√£o de data/hora de um agendamento existente\n- Novo hor√°rio est√° livre (confirmado pela \"Busca Disponibilidades\")\n- Cliente confirmou a nova data/hora\n- Voc√™ tem o agendamento_id do evento que deseja atualizar\n\n‚ùå N√ÉO USE SE:\n- N√£o verificou disponibilidade do novo hor√°rio primeiro\n- Novo hor√°rio est√° ocupado\n- N√£o tem agendamento_id (informe ao cliente e ofere√ßa criar novo evento)\n- Cliente n√£o confirmou a mudan√ßa\n\nüî¥ PAR√ÇMETROS:\n- event_id: ID do evento a atualizar (use o agendamento_id da DataTable)\n- start_at: Nova data/hora de in√≠cio no formato ISO 8601 UTC\n- end_at: Nova data/hora de t√©rmino (1 hora ap√≥s start_at) no formato ISO 8601 UTC\n\nüí° IMPORTANTE:\n- O evento ter√° dura√ß√£o de 1 hora a partir da nova data de in√≠cio\n- Sempre verifique disponibilidade antes de atualizar\n- Confirme com o cliente antes de fazer qualquer altera√ß√£o",
        "method": "PATCH",
        "url": "=https://controliaa.vercel.app/api/calendar/events/{{ /*n8n-auto-generated-fromAI*/ $fromAI('event_id', `ID do evento que deseja atualizar. Obtenha este ID do campo agendamento_id da DataTable ou do resultado anterior de cria√ß√£o de evento.`, 'string') }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoY3N5cHVkcHd3Zmxjb3J5Zm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MjIzMTMsImV4cCI6MjA4MTk5ODMxM30.rguJ34eShUCSKKBWuy8bBS7bSxuC5mCeRnXych0LGKM"
            },
            {
              "name": "x-company-id",
              "value": "={{ $('Webhook').first().json.body.controlia.company_id }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"company_id\": \"{{ $('Webhook').first().json.body.controlia.company_id }}\",\n  \"title\": \"Consulta com {{ $('Webhook').first().json.body.message.from.first_name || 'Cliente' }}\",\n  \"description\": \"Consulta atualizada via atendimento\",\n  \"start_at\": \"{{ /*n8n-auto-generated-fromAI*/ $fromAI('start_at', `Nova data e hora de in√≠cio do evento no formato ISO 8601 (ex: 2026-01-15T10:00:00Z). Deve ser uma data futura.`, 'string') }}\",\n  \"end_at\": \"{{ /*n8n-auto-generated-fromAI*/ $fromAI('end_at', `Nova data e hora de t√©rmino do evento no formato ISO 8601 (ex: 2026-01-15T11:00:00Z). Deve ser 1 hora ap√≥s o start_at.`, 'string') }}\",\n  \"is_all_day\": false,\n  \"location\": \"Online/Telefone\",\n  \"contact_id\": \"{{ $('Webhook').first().json.body.controlia.contact_id }}\",\n  \"visibility\": \"company\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        11552,
        992
      ],
      "id": "e64d00ff-dc11-44a9-bd9e-2ac693a937e1",
      "name": "Atualiza Eventos"
    },
    {
      "parameters": {
        "toolDescription": "‚úÖ CRIA UM NOVO AGENDAMENTO no calend√°rio.\n\n‚ö†Ô∏è USE ESTA FERRAMENTA QUANDO:\n- O cliente confirmar uma data/hora para agendamento (ex: \"sim, quero\", \"confirmo\", \"est√° bom\", \"pode ser\")\n- Ap√≥s voc√™ verificar disponibilidade e o hor√°rio estiver livre\n- O cliente mencionar diretamente uma data/hora que deseja agendar\n\nüìã FLUXO OBRIGAT√ìRIO:\n1. Ap√≥s criar o evento com esta ferramenta\n2. Voc√™ DEVE usar imediatamente \"Data table Update\" para salvar o ID retornado\n3. Confirme com o cliente a data, hora e dura√ß√£o (1 hora)\n\nüî¥ PAR√ÇMETROS OBRIGAT√ìRIOS (VOC√ä DEVE FORNECER):\n- start_at: Data/hora de in√≠cio no formato ISO 8601 (ex: 2026-01-15T10:00:00Z). Deve ser uma data FUTURA. Use a data mencionada pelo cliente ou da conversa sobre agendamento.\n- end_at: Data/hora de t√©rmino no formato ISO 8601 (ex: 2026-01-15T11:00:00Z). Deve ser exatamente 1 hora ap√≥s start_at.\n\nüí° IMPORTANTE: Se o cliente mencionou uma data espec√≠fica, use essa data. Se mencionou apenas hor√°rio, use o dia atual ou pr√≥ximo dia dispon√≠vel. Sempre calcule end_at = start_at + 1 hora.",
        "method": "POST",
        "url": "https://controliaa.vercel.app/api/calendar/events",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoY3N5cHVkcHd3Zmxjb3J5Zm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MjIzMTMsImV4cCI6MjA4MTk5ODMxM30.rguJ34eShUCSKKBWuy8bBS7bSxuC5mCeRnXych0LGKM"
            },
            {
              "name": "x-company-id",
              "value": "={{ $('Webhook').first().json.body.controlia.company_id }}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"company_id\": \"{{ $('Webhook').first().json.body.controlia.company_id }}\",\n  \"title\": \"Consulta com {{ $('Webhook').first().json.body.message.from.first_name || 'Cliente' }}\",\n  \"description\": \"Consulta agendada via atendimento\",\n  \"start_at\": \"{{ /*n8n-auto-generated-fromAI*/ ($fromAI('start_at', `Data e hora de in√≠cio do evento no formato ISO 8601 (ex: 2026-01-15T10:00:00Z). Deve ser uma data futura no hor√°rio de S√£o Paulo. Use a data mencionada pelo cliente ou da √∫ltima resposta sobre agendamento.`, 'string') || $now.setZone('America/Sao_Paulo').plus({ hours: 1 }).toUTC().toISO()) }}\",\n  \"end_at\": \"{{ /*n8n-auto-generated-fromAI*/ ($fromAI('end_at', `Data e hora de t√©rmino do evento no formato ISO 8601 (ex: 2026-01-15T11:00:00Z). Deve ser 1 hora ap√≥s o start_at. Se start_at for fornecido, calcule end_at = start_at + 1 hora.`, 'string') || $now.setZone('America/Sao_Paulo').plus({ hours: 2 }).toUTC().toISO()) }}\",\n  \"is_all_day\": false,\n  \"location\": \"Online/Telefone\",\n  \"contact_id\": \"{{ $('Webhook').first().json.body.controlia.contact_id }}\",\n  \"visibility\": \"company\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        11408,
        992
      ],
      "id": "91130f50-306f-4975-b6a0-6d3ee26665d0",
      "name": "Cria Evento"
    },
    {
      "parameters": {
        "toolDescription": "üóëÔ∏è EXCLUI um evento do calend√°rio da empresa no Controlia.\n\n‚ö†Ô∏è REGRAS OBRIGAT√ìRIAS ANTES DE USAR:\n\n1. **OBRIGAT√ìRIO**: SEMPRE confirme com o cliente ANTES de excluir o agendamento\n2. **OBRIGAT√ìRIO**: Voc√™ precisa do ID do evento (agendamento_id) que est√° armazenado na DataTable\n3. **OBRIGAT√ìRIO**: Garanta que o cliente confirmou explicitamente a exclus√£o\n\nüìã QUANDO USAR:\n- Cliente solicitou cancelamento de um agendamento existente\n- Cliente confirmou explicitamente que deseja excluir (\"sim, cancela\", \"pode cancelar\", \"quero excluir\")\n- Voc√™ tem o agendamento_id do evento que deseja excluir\n\n‚ùå N√ÉO USE SE:\n- Cliente n√£o confirmou explicitamente a exclus√£o\n- N√£o tem agendamento_id (informe ao cliente que n√£o h√° agendamento para excluir)\n- H√° d√∫vida sobre a inten√ß√£o do cliente (sempre confirme primeiro)\n\nüî¥ PAR√ÇMETROS:\n- event_id: ID do evento a excluir (use o agendamento_id da DataTable)\n\nüí° IMPORTANTE:\n- SEMPRE confirme com o cliente antes de excluir\n- Ap√≥s excluir, informe ao cliente que o agendamento foi cancelado\n- O agendamento_id ser√° removido automaticamente ou voc√™ pode atualizar a DataTable",
        "method": "DELETE",
        "url": "=https://controliaa.vercel.app/api/calendar/events/{{ /*n8n-auto-generated-fromAI*/ $fromAI('event_id', `ID do evento que deseja atualizar. Obtenha este ID do campo agendamento_id da DataTable ou do resultado anterior de cria√ß√£o de evento.`, 'string') }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpoY3N5cHVkcHd3Zmxjb3J5Zm1xIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0MjIzMTMsImV4cCI6MjA4MTk5ODMxM30.rguJ34eShUCSKKBWuy8bBS7bSxuC5mCeRnXych0LGKM"
            },
            {
              "name": "x-company-id",
              "value": "={{ $('Webhook').first().json.body.controlia.company_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.3,
      "position": [
        11696,
        992
      ],
      "id": "72cfb0a3-6433-4918-8f43-4d697142614a",
      "name": "Exclui Eventos"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook').first().json.body.message.text }}",
        "options": {
          "systemMessage": "={{ $('Concatenador #IA de Atendimento e Triagem').first().json.content_prompt_concatenado }}\n\n# CONTEXTO ATUAL (REAL-TIME)\n- Data/Hora Agora: {{ $now.setZone('America/Sao_Paulo').setLocale('pt-BR').toFormat(\"cccc, dd 'de' MMMM 'de' yyyy, HH:mm\") }}\n- Fuso Hor√°rio da Empresa: Am√©rica/S√£o Paulo (UTC-3).\n\n# STATUS DA TRIAGEM (MEM√ìRIA)\nAnalise o que j√° sabemos sobre o contato atual:\n- Nome: {{ $('Get row(s)').first().json.nome_completo || \"N√£o informado\" }}\n- Interesse (O que busca): {{ $('Get row(s)').first().json.interesse || \"N√£o informado\" }}\n- Contexto do Projeto (J√° tem sistema ou √© novo?): {{ $('Get row(s)').first().json.historico_tratamento || \"N√£o informado\" }}\n- Data da Reuni√£o: {{ $('Get row(s)').first().json.data_agendamento || \"N√£o agendado\" }}\n- ID do Agendamento (Sistema): {{ $('Get row(s)').first().json.agendamento_id || \"null\" }}\n\nContexto da Conversa:\n\nData/Hora Atual da conversa: {{ $now.setZone('America/Sao_Paulo').setLocale('pt-BR').toFormat('cccc') }}, {{ $now.setZone('America/Sao_Paulo').setLocale('pt-BR').toFormat(\"dd 'de' LLLL 'de' yyyy HH:mm'hrs'\") }}\n\nIdentifique o g√™nero atrav√©s do nome: {{ $('Webhook').first().json.body.message.from.first_name }}. De acordo com esse nome utilize artigos e pronomes adequados (Ex: \"Seja bem-vindo, Sr.\" ou \"Seja bem-vinda, Sra.\").\n\n√öltima intera√ß√£o:\n\nA √∫ltima pergunta do usu√°rio foi: {{ $('Get row(s)').first().json.ultima_pergunta_contato || \"Nenhuma\" }}.\nSua √∫ltima resposta foi: {{ $('Get row(s)').first().json.ultima_resposta_ia || \"Nenhuma\" }}.\n\n# ‚ö†Ô∏è REGRA ABSOLUTA: SEMPRE CONSULTE A AGENDA ‚ö†Ô∏è\n\n## QUANDO USAR \"Busca Disponibilidades\" (OBRIGAT√ìRIO):\n\nVoc√™ DEVE usar \"Busca Disponibilidades\" SEMPRE que:\n\n1. **Cliente pergunta sobre hor√°rios dispon√≠veis:**\n   - \"Quais hor√°rios voc√™ tem dispon√≠veis?\"\n   - \"Tem hor√°rio livre?\"\n   - \"Quando voc√™ pode me atender?\"\n   - \"Qual sua disponibilidade?\"\n   - \"Quais dias voc√™ est√° livre?\"\n   - Qualquer pergunta similar sobre hor√°rios ou disponibilidade\n   \n2. **Cliente menciona interesse em agendar:**\n   - \"Quero agendar uma reuni√£o\"\n   - \"Posso marcar uma consulta?\"\n   - \"Gostaria de agendar\"\n   - \"Quero marcar um hor√°rio\"\n   \n3. **ANTES de criar QUALQUER evento:**\n   - Mesmo que o cliente j√° tenha confirmado uma data/hora\n   - Mesmo que voc√™ j√° tenha consultado anteriormente na mesma conversa\n   - Esta √© uma regra OBRIGAT√ìRIA de seguran√ßa\n\n4. **ANTES de atualizar um evento existente:**\n   - Verifique se o novo hor√°rio est√° dispon√≠vel\n\n**IMPORTANTE**: \n- NUNCA responda sobre disponibilidade de hor√°rios SEM usar \"Busca Disponibilidades\" primeiro\n- NUNCA assuma que um hor√°rio est√° livre sem consultar\n- NUNCA invente hor√°rios dispon√≠veis - use APENAS os resultados da ferramenta\n- Se \"Busca Disponibilidades\" retornar vazio (nenhum evento), informe que h√° disponibilidade ampla\n- Se retornar eventos, informe os hor√°rios ocupados e sugira alternativas livres\n\n# ‚ö†Ô∏è REGRAS OBRIGAT√ìRIAS PARA FERRAMENTAS DE AGENDAMENTO ‚ö†Ô∏è\n\n## REGRA 1: SEMPRE USAR \"Busca Disponibilidades\" QUANDO:\n- O cliente perguntar sobre hor√°rios dispon√≠veis (OBRIGAT√ìRIO)\n- O cliente mencionar interesse em agendar uma data/hora espec√≠fica (OBRIGAT√ìRIO)\n- ANTES de criar QUALQUER evento (OBRIGAT√ìRIO)\n- ANTES de atualizar QUALQUER evento (OBRIGAT√ìRIO)\n\n**A√á√ÉO OBRIGAT√ìRIA**: Se o cliente pedir hor√°rios dispon√≠veis ou mencionar interesse em agendar, voc√™ DEVE usar \"Busca Disponibilidades\" IMEDIATAMENTE, SEM EXCE√á√ÉO.\n\n## REGRA 2: SEMPRE USAR \"Cria Evento\" QUANDO:\n- O cliente confirmar uma data/hora para agendamento (ex: \"sim, quero agendar\", \"confirmo\", \"est√° bom\", \"pode ser nesse hor√°rio\")\n- Ap√≥s voc√™ ter verificado disponibilidade e o hor√°rio estiver livre (confirmado por \"Busca Disponibilidades\")\n- Cliente deu consentimento expl√≠cito\n\n**A√á√ÉO OBRIGAT√ìRIA**: Se o cliente confirmar uma data AP√ìS voc√™ ter verificado disponibilidade, voc√™ DEVE usar \"Cria Evento\" para criar o agendamento.\n\n## REGRA 3: FLUXO OBRIGAT√ìRIO DE AGENDAMENTO:\n\n1. Cliente menciona interesse em agendar OU pergunta sobre hor√°rios\n   ‚Üí **VOC√ä DEVE USAR \"Busca Disponibilidades\"** (OBRIGAT√ìRIO)\n\n2. Ap√≥s verificar disponibilidade:\n   - Se livre (array vazio ou hor√°rio n√£o est√° na lista): **VOC√ä DEVE USAR \"Cria Evento\"** se cliente confirmar\n   - Se ocupado: Informe ao cliente e sugira alternativas livres\n\n3. Ap√≥s criar evento com sucesso:\n   ‚Üí **VOC√ä DEVE USAR \"Data table Update\"** para salvar o ID do agendamento (OBRIGAT√ìRIO)\n\n## REGRA 4: INTERPRETA√á√ÉO DE CONFIRMA√á√ÉO:\n\nConsidere como CONFIRMA√á√ÉO de agendamento:\n- \"Sim\", \"Confirmo\", \"Pode ser\", \"Est√° bom\", \"Perfeito\", \"√ìtimo\"\n- \"Quero agendar para [data/hora]\"\n- \"Pode ser amanh√£ √†s 10h\"\n- Qualquer resposta positiva ap√≥s voc√™ sugerir um hor√°rio\n\nQuando houver confirma√ß√£o, voc√™ DEVE usar \"Cria Evento\" APENAS se j√° verificou disponibilidade primeiro.\n\n## REGRA 5: N√ÉO PULE ETAPAS\n\nNUNCA crie um evento sem antes verificar disponibilidade. Esta √© uma regra ABSOLUTA.\n\n## EXEMPLOS DE USO CORRETO:\n\n**Cen√°rio 1 - Cliente pergunta hor√°rios:**\nCliente: \"quais hor√°rios voc√™ tem dispon√≠veis?\"\n‚Üí Voc√™ DEVE usar \"Busca Disponibilidades\" AGORA (OBRIGAT√ìRIO)\n‚Üí Analise os resultados\n‚Üí Se vazio: informe ampla disponibilidade e sugira hor√°rios\n‚Üí Se houver eventos: liste ocupados e sugira livres\n‚Üí Se o cliente confirmar, use \"Cria Evento\"\n\n**Cen√°rio 2 - Cliente menciona data espec√≠fica:**\nCliente: \"quero agendar para amanh√£ √†s 10h\"\n‚Üí Voc√™ DEVE usar \"Busca Disponibilidades\" primeiro para verificar (OBRIGAT√ìRIO)\n‚Üí Se livre (hor√°rio n√£o est√° na lista), use \"Cria Evento\" imediatamente\n‚Üí Use \"Data table Update\" para salvar o ID\n\n**Cen√°rio 3 - Cliente confirma ap√≥s verifica√ß√£o:**\nVoc√™: \"Tenho disponibilidade amanh√£ √†s 10h, 14h ou 16h\" (baseado em \"Busca Disponibilidades\")\nCliente: \"Pode ser √†s 14h\"\n‚Üí Voc√™ DEVE usar \"Cria Evento\" AGORA (j√° verificou disponibilidade anteriormente)\n‚Üí Use \"Data table Update\" para salvar o ID\n\n## LEMBRE-SE:\n- NUNCA responda sobre hor√°rios sem consultar \"Busca Disponibilidades\" primeiro\n- NUNCA invente hor√°rios dispon√≠veis - use apenas os dados da ferramenta\n- Sempre verifique disponibilidade antes de criar qualquer evento\n- Se o cliente confirmar, crie o evento imediatamente (ap√≥s verifica√ß√£o)\n- Sempre salve o ID do agendamento ap√≥s criar"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3.1,
      "position": [
        11712,
        784
      ],
      "id": "618b7f3c-6dee-4953-8574-55e2e61bdac8",
      "name": "AI Agent - Respostas"
    },
    {
      "parameters": {
        "model": "mistralai/mistral-7b-instruct:free",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        10608,
        992
      ],
      "id": "2f561187-e5ec-407e-85ac-06c234f1429f",
      "name": "OpenRouter Chat Model",
      "executeOnce": true,
      "credentials": {
        "openRouterApi": {
          "id": "oCEAbSfV7X4LHYED",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": "mistralai/mistral-7b-instruct",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        10928,
        992
      ],
      "id": "07cb6d03-79b9-4941-9297-a1baf69cfc44",
      "name": "OpenRouter Chat Model1",
      "credentials": {
        "openRouterApi": {
          "id": "oCEAbSfV7X4LHYED",
          "name": "OpenRouter account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        10448,
        992
      ],
      "id": "29e15938-bca7-4a4c-a53d-24fc0a60d1b4",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "KKcz58kOwzIUk1WI",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.3,
      "position": [
        10768,
        992
      ],
      "id": "5bf372e9-9793-42c7-9fdc-13549ccf4dad",
      "name": "OpenAI Chat Model1",
      "executeOnce": true,
      "credentials": {
        "openAiApi": {
          "id": "KKcz58kOwzIUk1WI",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "model": "text-embedding-3-small",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1,
      "position": [
        12000,
        992
      ],
      "id": "c53f087f-41cd-4a9b-aef5-c9a2ba5b10fc",
      "name": "Embeddings OpenAI1",
      "rewireOutputLogTo": "ai_tool",
      "credentials": {
        "openAiApi": {
          "id": "KKcz58kOwzIUk1WI",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "mode": "retrieve-as-tool",
        "toolDescription": "Busca informa√ß√µes relevantes na base de conhecimento da empresa para responder a perguntas do cliente. Use esta ferramenta quando o cliente fizer perguntas sobre produtos, servi√ßos, pol√≠ticas, procedimentos ou qualquer informa√ß√£o espec√≠fica da empresa que voc√™ n√£o tenha certeza. Retorna trechos de documentos relevantes.",
        "tableName": {
          "__rl": true,
          "value": "document_chunks",
          "mode": "list",
          "cachedResultName": "document_chunks"
        },
        "filters": {
          "filterType": "manual",
          "matchType": "allMatch",
          "conditions": [
            {
              "keyName": "company_id",
              "condition": "equal",
              "keyValue": "={{ $('Webhook').first().json.body.controlia.company_id }}"
            },
            {
              "keyName": "is_indexed",
              "condition": "equal",
              "keyValue": "true"
            }
          ]
        },
        "options": {
          "topK": 5,
          "similarityThreshold": 0.7
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1.3,
      "position": [
        12144,
        976
      ],
      "id": "341a3a32-4bbb-4983-b3ec-b2b8a0c8d6d2",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "MJeuWnGfcHw2J9Ll",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Webhook').first().json.body.controlia.conversation_id }}_assistente",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        11088,
        992
      ],
      "id": "483d6058-d78b-48f8-8990-f09107dab01d",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "modelName": "models/gemma-3-4b-it",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        10448,
        1152
      ],
      "id": "ef818f33-c0eb-4008-912b-35db40ce8ed1",
      "name": "Google Gemini Chat Model",
      "alwaysOutputData": true,
      "credentials": {
        "googlePalmApi": {
          "id": "ZSPWkeAGgSAH48EB",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        10608,
        1152
      ],
      "id": "e7257fc4-7620-48ad-9d74-bd4ca19be734",
      "name": "Google Gemini Chat Model1",
      "alwaysOutputData": true,
      "credentials": {
        "googlePalmApi": {
          "id": "ZSPWkeAGgSAH48EB",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Define:Mensagem e Session_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar/atualizar sessionId": {
      "main": [
        [
          {
            "node": "Get row(s)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)": {
      "main": [
        [
          {
            "node": "#Prompt IA de Atendimento e Triagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AtualizaVariaveisExtrator": {
      "main": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AtualizaPerguntaResposta": {
      "main": [
        [
          {
            "node": "Prepare Response Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Data table Update": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s)1": {
      "main": [
        [
          {
            "node": "AtualizaPerguntaResposta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Prompt Extractor": {
      "main": [
        [
          {
            "node": "Information Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor": {
      "main": [
        [
          {
            "node": "AtualizaVariaveisExtrator",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Define:Mensagem e Session_id": {
      "main": [
        [
          {
            "node": "Criar/atualizar sessionId",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "#Prompt IA de Atendimento e Triagem": {
      "main": [
        [
          {
            "node": "Concatenador #IA de Atendimento e Triagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Concatenador #IA de Atendimento e Triagem": {
      "main": [
        [
          {
            "node": "#Prompt Extra√ß√£o de Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "#Prompt Extra√ß√£o de Dados": {
      "main": [
        [
          {
            "node": "Processar Prompt Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Response Data": {
      "main": [
        [
          {
            "node": "HTTP Request (Enviar Resposta)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Busca Disponibilidades": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Atualiza Eventos": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Cria Evento": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Exclui Eventos": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Respostas": {
      "main": [
        [
          {
            "node": "Get row(s)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent - Respostas",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        []
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        []
      ]
    }
  },
  "pinData": {
    "Webhook": [
      {
        "headers": {
          "host": "controlia.up.railway.app",
          "user-agent": "node",
          "content-length": "1183",
          "accept": "*/*",
          "accept-encoding": "br, gzip, deflate",
          "accept-language": "*",
          "content-type": "application/json",
          "sec-fetch-mode": "cors",
          "x-forwarded-for": "35.153.144.228",
          "x-forwarded-host": "controlia.up.railway.app",
          "x-forwarded-proto": "https",
          "x-railway-edge": "railway/us-east4-eqdc4a",
          "x-railway-request-id": "vkaFwG_KQumyamWqg4a9AQ",
          "x-real-ip": "35.153.144.228",
          "x-request-start": "1767314704789",
          "x-vercel-id": "fra1::h24dn-1767314702861-00d6d47da9f1",
          "x-webhook-secret": "N0v4F0rg3@2025"
        },
        "params": {},
        "query": {},
        "body": {
          "update_id": 906311006,
          "message": {
            "message_id": 574,
            "from": {
              "id": 7772641515,
              "is_bot": false,
              "first_name": "Jailton",
              "last_name": "Silva",
              "language_code": "pt-br"
            },
            "chat": {
              "id": 7772641515,
              "first_name": "Jailton",
              "last_name": "Silva",
              "type": "private"
            },
            "date": 1767314702,
            "text": "vreifique novamente"
          },
          "controlia": {
            "company_id": "cae292bd-2cc7-42b9-9254-779ed011989e",
            "contact_id": "9cd516cf-c011-4d98-92c8-3830a6c2ac83",
            "conversation_id": "53bc9d7a-8bb3-492f-8042-1f5cdb64f297",
            "message_id": "1afc1624-37d7-44aa-8119-02a3fa90aeb9",
            "channel": "telegram",
            "callback_url": "https://controliaa.vercel.app/api/webhooks/n8n/channel-response",
            "contact": {
              "id": "9cd516cf-c011-4d98-92c8-3830a6c2ac83",
              "name": "Jailton Silva",
              "email": null,
              "phone": null,
              "whatsapp": null,
              "document": null,
              "status": "lead",
              "source": "telegram",
              "score": 0,
              "notes": null,
              "tags": null,
              "ai_enabled": true,
              "custom_fields": {
                "interesse": "Sistema Web",
                "telegram_id": "7772641515",
                "data_agendamento": "2026-01-08T18:00:00.000Z",
                "telegram_username": null,
                "historico_tratamento": "Primeira vez contratando"
              },
              "created_at": "2026-01-01T22:38:06.44661+00:00",
              "updated_at": "2026-01-02T00:45:03.362931+00:00",
              "last_interaction_at": "2026-01-02T00:45:02+00:00"
            }
          }
        },
        "webhookUrl": "https://controlia.up.railway.app/webhook/webhook/7ab5d664-349d-4ad2-84f1-23da3b2df1a7/webhook",
        "executionMode": "production"
      }
    ]
  },
  "meta": {
    "templateId": "self-building-ai-agent",
    "templateCredsSetupCompleted": true,
    "instanceId": "4a22749bbc8ec20e8bba632ac1dd5cfc3d01dc0f58c987349b16ee15b7554ab1"
  }
}